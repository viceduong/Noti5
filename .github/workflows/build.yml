name: Build Noti5 for TrollStore

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: macos-14  # macOS Sonoma with Xcode 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List available Xcode versions
        run: ls -la /Applications/ | grep Xcode

      - name: Select Xcode version
        run: |
          # Try to find available Xcode
          if [ -d "/Applications/Xcode_15.4.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          elif [ -d "/Applications/Xcode_15.3.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.3.app/Contents/Developer
          elif [ -d "/Applications/Xcode_15.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          elif [ -d "/Applications/Xcode_15.1.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode_15.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app" ]; then
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install ldid
        run: brew install ldid

      - name: Create Xcode project
        run: |
          chmod +x scripts/generate_xcodeproj.sh
          ./scripts/generate_xcodeproj.sh

      - name: List project structure
        run: |
          echo "=== Project structure ==="
          ls -la
          echo "=== Noti5 folder ==="
          ls -la Noti5/
          echo "=== Noti5/App folder ==="
          ls -la Noti5/App/
          echo "=== Generated xcodeproj ==="
          ls -la Noti5.xcodeproj/

      - name: Build Main App
        run: |
          xcodebuild -project Noti5.xcodeproj \
            -scheme Noti5 \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            ONLY_ACTIVE_ARCH=NO \
            2>&1 | tee build.log

          # Check if build succeeded
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "=== Build failed. Last 100 lines of log: ==="
            tail -100 build.log
            exit 1
          fi

      - name: Build Root Helper
        run: |
          cd RootHelper

          # Compile Objective-C files
          clang -fobjc-arc -fmodules \
            -target arm64-apple-ios14.0 \
            -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
            -framework Foundation \
            -framework CoreFoundation \
            -o roothelper \
            main.m SEGBParser.m NotificationMonitor.m RuleMatcher.m

          echo "Root helper built successfully"
          ls -la roothelper

      - name: Create App Bundle
        run: |
          # Find the built app
          APP_PATH=$(find build -name "Noti5.app" -type d | head -1)
          echo "Found app at: $APP_PATH"

          if [ -z "$APP_PATH" ]; then
            echo "App not found, creating manually..."
            mkdir -p build/Build/Products/Release-iphoneos/Noti5.app
            APP_PATH="build/Build/Products/Release-iphoneos/Noti5.app"
          fi

          # Copy root helper into app bundle
          cp RootHelper/roothelper "$APP_PATH/"
          chmod 755 "$APP_PATH/roothelper"

          # Copy Info.plist if needed
          cp Noti5/Info.plist "$APP_PATH/" 2>/dev/null || true

          echo "App bundle contents:"
          ls -la "$APP_PATH/"

      - name: Sign with ldid
        run: |
          APP_PATH=$(find build -name "Noti5.app" -type d | head -1)

          echo "Signing main app..."
          ldid -SNoti5/Noti5.entitlements "$APP_PATH/Noti5"

          echo "Signing root helper..."
          ldid -SRootHelper/roothelper.entitlements "$APP_PATH/roothelper"

          echo "Signing complete"

      - name: Create TrollStore IPA
        run: |
          APP_PATH=$(find build -name "Noti5.app" -type d | head -1)

          # Create Payload structure
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/

          # Create .tipa (TrollStore IPA)
          zip -r Noti5.tipa Payload

          echo "Created Noti5.tipa"
          ls -la Noti5.tipa

      - name: Upload TrollStore IPA
        uses: actions/upload-artifact@v4
        with:
          name: Noti5-TrollStore
          path: Noti5.tipa
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: Noti5.tipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
